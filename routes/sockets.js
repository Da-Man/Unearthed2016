var sqlite3 = require('sqlite3');

//db = new sqlite3.Database('../surge.db', sqlite3.OPEN_READONLY);

data = {"1101047CL1.CPV2": "NULL", "3311FV380B.PV": "NULL", "3311FV690B.PV": "NULL", "3311PI591.PV": 0.511292, "3311SI614A.PV": 0, "3311SI614B.PV": 0, "3311ZI616.PV": 0.3273302, "CR002RUN":  "NULL", "CR003RUN": "NULL", "CV2010VSD.MV": 0, "FD2003VSD.MV": "NULL", "FD2004VSD.MV": "NULL", "FD2005VSD.MV": "NULL", "FD2007VSD.MV": 0, "FI22302.PV": -0.3688292, "FI22310.PV": -0.175171, "FI22963": "NULL", "FY22302CL2.CPV1": 137.3126068}
dataset1 ={"1101047CL1.CPV2": "NULL", "3311FV380B.PV": "NULL", "3311FV690B.PV": "NULL", "3311PI591.PV": 1.6902115, "3311SI614A.PV": 0, "3311SI614B.PV": 0, "3311ZI616.PV": -0.014796, "CR002RUN":  "NULL", "CR003RUN": "NULL", "CV2010VSD.MV": 0, "FD2003VSD.MV": 0, "FD2004VSD.MV": 92, "FD2005VSD.MV": 0, "FD2007VSD.MV": 0, "FI22302.PV": 319.7393799, "FI22310.PV": 160.236908, "FI22963": "NULL", "FY22302CL2.CPV1": 0.7398983}
dataset1 ={"1101047CL1.CPV2": 704718, "3311FV380B.PV": "NULL", "3311FV690B.PV": "NULL", "3311PI591.PV": 148.5177917, "3311SI614A.PV": 64.9124222, "3311SI614B.PV": 64.4822922, "3311ZI616.PV": -1.7024655, "CR002RUN": "NULL", "CR003RUN": "NULL", "CV2010VSD.MV": 76.0535507, "FD2003VSD.MV": 90.2551041, "FD2004VSD.MV": 56, "FD2005VSD.MV": 10, "FD2007VSD.MV": 63.8080559, "FI22302.PV": 583.894165, "FI22310.PV": 235.6731262, "FI22963": 496.6560364, "FY22302CL2.CPV1": 77.2126465}
dataset1 ={"1101047CL1.CPV2": 708270, "3311FV380B.PV": "NULL", "3311FV690B.PV": "NULL", "3311PI591.PV": 149.5665436, "3311SI614A.PV": 67.9501038, "3311SI614B.PV": 67.6234589, "3311ZI616.PV": -1.7431022, "CR002RUN": "NULL", "CR003RUN": "NULL", "CV2010VSD.MV": 67.0877075, "FD2003VSD.MV": 0, "FD2004VSD.MV": 91.4224167, "FD2005VSD.MV": 0, "FD2007VSD.MV": 56.353672, "FI22302.PV": 484.9697571, "FI22310.PV": 180.7627563, "FI22963": 637.9346924, "FY22302CL2.CPV1": 75.7619171}
dataset1 ={"1101047CL1.CPV2": 727466, "3311FV380B.PV": "NULL", "3311FV690B.PV": "NULL", "3311PI591.PV": 80.4948044, "3311SI614A.PV": 28.1226273, "3311SI614B.PV": 28.1684761, "3311ZI616.PV": 0.1269968, "CR002RUN": "NULL", "CR003RUN": "NULL", "CV2010VSD.MV": 0, "FD2003VSD.MV": 80.2120209, "FD2004VSD.MV": 56, "FD2005VSD.MV": 0, "FD2007VSD.MV": 0, "FI22302.PV": -0.5653908, "FI22310.PV": 0.076141, "FI22963": 569.4360962, "FY22302CL2.CPV1": 133.2723999}
dataset1 ={"1101047CL1.CPV2": 474612, "3311FV380B.PV": "NULL", "3311FV690B.PV": "NULL", "3311PI591.PV": 154.6487122, "3311SI614A.PV": 72.6658249, "3311SI614B.PV": 72.7710114, "3311ZI616.PV": 2.172668, "CR002RUN": "NULL", "CR003RUN": "NULL", "CV2010VSD.MV": 80.7654037, "FD2003VSD.MV": 87.3358765, "FD2004VSD.MV": 56, "FD2005VSD.MV": 10, "FD2007VSD.MV": 67.5716324, "FI22302.PV": 557.7262573, "FI22310.PV": 224.2081146, "FI22963": 641.7697754, "FY22302CL2.CPV1": 78.5925369}
dataset1 = {"1101047CL1.CPV2": 474612, "3311FV380B.PV": "NULL", "3311FV690B.PV": "NULL", "3311PI591.PV": 156.171524, "3311SI614A.PV": 72.248558, "3311SI614B.PV": 72.3794403, "3311ZI616.PV": 2.0175979, "CR002RUN": "NULL", "CR003RUN": "NULL", "CV2010VSD.MV": 79.3966217, "FD2003VSD.MV": 87.2132416, "FD2004VSD.MV": 56, "FD2005VSD.MV": 10, "FD2007VSD.MV": 66.632782, "FI22302.PV": 558.0578613, "FI22310.PV": 223.9370728, "FI22963": 637.7537231, "FY22302CL2.CPV1": 78.6689682}
dataset1 = {"1101047CL1.CPV2": 474612, "3311FV380B.PV": "NULL", "3311FV690B.PV": "NULL", "3311PI591.PV": 156.5384674, "3311SI614A.PV": 72.6541595, "3311SI614B.PV": 72.5960999, "3311ZI616.PV": 2.3993616, "CR002RUN": "NULL", "CR003RUN": "NULL", "CV2010VSD.MV": 80.705368, "FD2003VSD.MV": 87.3943176, "FD2004VSD.MV": 56, "FD2005VSD.MV": 10, "FD2007VSD.MV": 68.126564, "FI22302.PV": 559.4226074, "FI22310.PV": 223.7044373, "FI22963": 644.7401123, "FY22302CL2.CPV1": 78.5466766}




function createQuery() {
	variableList = ["1101047CL1.CPV2", "3311FV380B.PV", "3311FV690B.PV", "3311PI591.PV", "3311SI614A.PV", "3311SI614B.PV", "3311ZI616.PV", "CR002RUN", "CR003RUN", "CV2010VSD.MV", "FD2003VSD.MV", "FD2004VSD.MV", "FD2005VSD.MV", "FD2007VSD.MV", "FI22302.PV", "FI22310.PV", "FI22963", "FY22302CL2.CPV1"];
	queryPartOne = 'SELECT "3311WI671.PV" FROM surge WHERE '
	query = [];
	modifier = 0.05;

	for (var i = 0; i < variableList.length; i++) {

		if (data[variableList[i]] == 'NULL') {
			query_line = variableList[i] + ' = ' + (data[variableList[i]])	
		} else {
			query_line = variableList[i] + ' >= ' + (parseFloat(data[variableList[i]]) * (1-modifier)).toString() + ' AND ' + variableList[i] + " <= " + (parseFloat(data[variableList[i]]) * (1 + modifier)).toString();		
		}		
		query.push(query_line);
	}

	console.log(queryPartOne + query.join(' AND ') + ';');

	//return query;
}



function add(a, b) {
    return a + b;
}

function doQuery(query) {
	surgeValue = 656;
	rowsAboveSurgeValue = []
	db.all(createQuery(data), function(err, rows) {
		for (var i = 0; i < rows.length; i++) {
			if(rows[i] >= surgeValue){
				rowsAboveSurgeValue.push(rows[i]);
			}
		}
	});
}

module.exports = {
	"run" : function (io) {
		io.on ('connection', function (socket) {
			socket.on('setQuery', function(data)  {
				createQuery();

			});
		});
	}
}
